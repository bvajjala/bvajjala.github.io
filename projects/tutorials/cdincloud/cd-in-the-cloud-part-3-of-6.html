
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Tutorial : Continuous Delivery in the Cloud Part 3 of 6 - Balaji Vajjala's Blog</title>
  <meta name="author" content="Balaji Vajjala">

  
  <meta name="description" content="Tutorial : Continuous Delivery in the Cloud Part 3 of 6 In part 1 of this series, I introduced theContinuous Delivery
(CD) pipeline for theManatee &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://bvajjala.github.io/projects/tutorials/cdincloud/cd-in-the-cloud-part-3-of-6.html">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Balaji Vajjala's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="/assets/slides/css/for_blog.css">

  

</head>

<body   class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <h1><a href="/">Balaji Vajjala's Blog</a></h1>
  
    <h2>A DevOps Blog from Trenches</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:bvajjala.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/about/home">Home</a></li> 
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/blog/categories">Categories</a></li>
  <li><a href="/projects">Projects</a></li>
  <li><a href="/about/resume">About Me</a></li>
  <li><a href="/about/consulting">Consulting</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article role="article">
  
  <header>
    <h1 class="entry-title">Tutorial : Continuous Delivery in the Cloud Part 3 of 6</h1>
    
  </header>
  
  <p>In <a href="http://www.stelligent.com/wp-admin/continuous-delivery-in-the-cloud-case-study-for-the-sea-to-shore-alliance-introduction-part-1-of-6">part 1 of this series</a>, I introduced the<a href="http://refcardz.dzone.com/refcardz/continuous-delivery-patterns">Continuous Delivery</a>
(CD) pipeline for the<a href="http://manatees.mapntracker.com/wildtracks/">Manatee Tracking application</a>.
In <a href="../continuous-delivery-in-the-cloud-cd-pipeline-part-2-of-6/index.html" title="Continuous Delivery pipeline">part 2</a> I went over how we use this CD pipeline to deliver software from checkin to production. A list of topics for each of the articles is summarized below.</p>

<p><a href="../continuous-delivery-in-the-cloud-case-study-for-the-sea-to-shore-alliance-introduction-part-1-of-6/index.html">Part 1: Introduction</a>
– introduction to continuous delivery in the cloud and the rest of the articles;
 <a href="../continuous-delivery-in-the-cloud-cd-pipeline-part-2-of-6/index.html">Part 2: CD Pipeline</a>
– In-depth look at the CD Pipeline
 Part 3: CloudFormation – What you’re reading now<br/>
 <a href="../continuous-delivery-in-the-cloud-dynamic-configuration-part-4-of-6/index.html">Part 4: Dynamic Configuration</a>
– “Property file less” infrastructure;
 <a href="../continuous-delivery-in-the-cloud-deployment-automation-part-5-of-6/index.html">Part 5: Deployment Automation</a>
– Scripted deployment orchestration;
 <a href="../continuous-delivery-in-the-cloud-infrastructure-automation-part-6-of-6/index.html">Part 6: Infrastructure Automation</a>
– Scripted environment provisioning (Infrastructure Automation)</p>

<p>In this part of the series, I am going to explain how we use CloudFormation to script our AWS infrastructure and provision our Jenkins environment.</p>

<p><strong>What is CloudFormation?</strong>
 <a href="http://aws.amazon.com/cloudformation/">CloudFormation</a> is an AWS offering for scripting AWS virtual resource allocation. A CloudFormation template is a JSON script which references various AWS resources that you want to use. When the template runs, it will allocate the AWS resources accordingly.</p>

<p>A CloudFormation template is split up into four sections:</p>

<ol>
<li><strong>Parameters</strong>: <a href="http://docs.amazonwebservices.com/AWSCloudFormation/latest/UserGuide/concept-parameters.html">Parameters</a>     are values that you define in the template. When creating the stack    through the AWS console, you will be prompted to enter in values for     the Parameters. If the value for the parameter generally stays the     same, you can set a default value. Default values can be overridden     when creating the stack. The parameter can be used throughout the     template by using the     “<a href="http://docs.amazonwebservices.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-ref.html">Ref</a>”     function.</li>
<li><strong>Mappings</strong>:     <a href="http://docs.amazonwebservices.com/AWSCloudFormation/latest/UserGuide/concept-mappings.html">Mappings</a>     are for specifying conditional parameter values in your template.     For instance you might want to use a different AMI depending on the     region your instance is running on. Mappings will enable you to     switch AMIs depending on the region the instance is being created     in.</li>
<li><strong>Resources</strong>:     <a href="http://docs.amazonwebservices.com/AWSCloudFormation/latest/UserGuide/concept-resources.html">Resources</a>     are the most vital part of the CloudFormation template. Inside the     resource section, you define and configure your AWS components.</li>
<li><strong>Outputs</strong>: After the stack resources are created successfully, you    may want to have it return values such as the IP address or the     domain of the created instance. You use Outputs for this.     <a href="http://docs.amazonwebservices.com/AWSCloudFormation/latest/UserGuide/concept-outputs.html">Outputs</a>     will return the values to the AWS console or command line depending     on which medium you use for creating a stack.</li>
</ol>


<p>CloudFormation parameters, and resources can be <a href="http://docs.amazonwebservices.com/AWSCloudFormation/latest/UserGuide/concept-property-references.html">referenced</a> throughout the template. You do this using intrinsic functions,
<a href="http://docs.amazonwebservices.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-ref.html">Ref</a>, <a href="http://docs.amazonwebservices.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-base64.html">Fn::Base64</a>,<a href="http://docs.amazonwebservices.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-findinmap.html">Fn::FindInMap</a>, <a href="http://docs.amazonwebservices.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-getatt.html">Fn::GetAtt</a>,<a href="http://docs.amazonwebservices.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-getavailabilityzones.html">Fn::GetAZs</a> and <a href="http://docs.amazonwebservices.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-join.html">Fn::Join</a>.</p>

<p>These functions enable you to pass properties and resource outputs throughout your template – reducing the need for most hardcoded properties (something I will discuss in part 4 of this series, <em>Dynamic Configuration</em>).</p>

<p><strong>How do you run a CloudFormation template?</strong>
 You can create a CloudFormation stack using either the <a href="https://console.aws.amazon.com/cloudformation/home?" title="AWS Console">AWS Console</a>, <a href="http://docs.amazonwebservices.com/AWSCloudFormation/latest/UserGuide/cfn-using-cli.html" title="CloudFormation CLI tools">CloudFormation CLI tools</a> or the <a href="http://docs.amazonwebservices.com/AWSCloudFormation/latest/APIReference" title="CloudFormation API">CloudFormation API</a>.</p>

<p><strong>Why do we use CloudFormation?</strong>
 We use CloudFormation in order to have a fully scripted, versioned infrastructure. From the application to the virtual resources, everything is created from a script and is checked into version control. This gives us complete control over our AWS infrastructure which can be recreated whenever necessary.</p>

<p><strong>CloudFormation for Manatees</strong>
 In the Manatee Infrastructure, we use CloudFormation for setting up the Jenkins CD environment. I am going to go through each part of the jenkins template and explain its use and purpose. In template’s lifecycle, the user launches the stack using the jenkins.template and enters in the Parameters. The template then starts to work:</p>

<p>​1. <a href="http://aws.amazon.com/iam/">IAM</a> User with <a href="https://portal.aws.amazon.com/gp/aws/securityCredentials">AWS Access keys</a> is created
 2. SNS Topic is created
 3. CloudWatch Alarm is created and SNS topic is used for sending alarm notifications
 4. Security Group is created
 5. Wait Condition created
 6. Jenkins EC2 Instance is created with the Security Group from step #4. This security group is used for port configuration. It also uses AWSInstanceType2Arch and AWSRegionArch2AMI to decide what AMI and OS type to use
 7. Jenkins EC2 Instance runs <code>UserData</code> script and executes <code>cfn_init</code>.
 8. Wait Condition waits for Jenkins EC2 instance to finish <code>UserData</code> script
 9. Elastic IP is allocated and associated with Jenkins EC2 instance
 10. Route53 domain name created and associated with Jenkins Elastic IP
 11. If everything creates successfully, the stack signals complete and outputs are displayed</p>

<p>Now that we know at a high level what is being done, lets take a deeper look at what’s going on inside the <code>jenkins.template</code>.</p>

<h2>Parameters</h2>

<ul>
<li><strong>Email:</strong> Email address that SNS notifications will be sent. When     we create or deploy to target environments, we use SNS to notify us     of their status.</li>
<li><strong>ApplicationName:</strong> Name of A Record created by Route53. Inside the     template, we dynamically create a domain with A record for easy     access to the instance after creation. Example:     jenkins.integratebutton.com, jenkins is the ApplicationName</li>
<li><strong>HostedZone:</strong> Name of Domain used Route53. Inside the template, we     dynamically create a domain with A record for easy access to the     instance after creation. Example: jenkins.integratebutton.com,     integratebutton.com is the HostedZone.</li>
<li><strong>KeyName</strong>: EC2 SSH Keypair to create the Instance with. This is     the key you use to ssh into the Jenkins instance after creation.</li>
<li><strong>InstanceType:</strong> Size of the EC2 instance. Example: t1.micro,     c1.medium</li>
<li><strong>S3Bucket:</strong> We use a S3 bucket for containing the resources for     the Jenkins template to use, this parameter specifies the name of     the bucket to use for this.</li>
</ul>


<p> </p>

<h2>Mappings</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> "Mappings" : {
</span><span class='line'>   "AWSInstanceType2Arch" : {
</span><span class='line'>     "t1.micro" : { "Arch" : "64" },
</span><span class='line'>     "m1.small" : { "Arch" : "32" },
</span><span class='line'>     "m1.large" : { "Arch" : "64" },
</span><span class='line'>     "m1.xlarge" : { "Arch" : "64" },
</span><span class='line'>     "m2.xlarge" : { "Arch" : "64" },
</span><span class='line'>     "m2.2xlarge" : { "Arch" : "64" },
</span><span class='line'>     "m2.4xlarge" : { "Arch" : "64" },
</span><span class='line'>     "c1.medium" : { "Arch" : "64" },
</span><span class='line'>     "c1.xlarge" : { "Arch" : "64" },
</span><span class='line'>     "cc1.4xlarge" : { "Arch" : "64" }
</span><span class='line'>   },
</span><span class='line'>     "AWSRegionArch2AMI" : {
</span><span class='line'>     "us-east-1" : { "32" : "ami-ed65ba84", "64" : "ami-e565ba8c" }   
</span><span class='line'> } 
</span><span class='line'> },</span></code></pre></td></tr></table></div></figure>


<p>These Mappings are used to define what type of operating system architecture and AWS AMI (Amazon Machine Image) ID to use to use based upon the Instance size. The instance size is specified using the Parameter <strong>InstanceType</strong></p>

<p>The conditional logic to interact with the Mappings is done inside the EC2 instance.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> "ImageId" : {
</span><span class='line'>  "Fn::FindInMap" : [
</span><span class='line'>   "AWSRegionArch2AMI", 
</span><span class='line'>    {"Ref" : "AWS::Region" },
</span><span class='line'>    { "Fn::FindInMap" : [ 
</span><span class='line'>     "AWSInstanceType2Arch", { 
</span><span class='line'>       "Ref" : "InstanceType" 
</span><span class='line'>       },
</span><span class='line'>        "Arch" 
</span><span class='line'>        ] }
</span><span class='line'>         ]
</span><span class='line'>    },</span></code></pre></td></tr></table></div></figure>


<h2>Resources</h2>

<p><strong><a href="http://docs.amazonwebservices.com/AWSCloudFormation/latest/UserGuide/aws-properties-iam-user.html">AWS::IAM::User</a></strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> "CfnUser" : {
</span><span class='line'>   "Type" : "AWS::IAM::User",
</span><span class='line'>   "Properties" : {
</span><span class='line'>     "Path": "/",
</span><span class='line'>     "Policies": [{
</span><span class='line'>       "PolicyName": "root",
</span><span class='line'>       "PolicyDocument": { "Statement":[{
</span><span class='line'>         "Effect":"Allow",
</span><span class='line'>         "Action":"*",
</span><span class='line'>         "Resource":"*"
</span><span class='line'>         }
</span><span class='line'>       ]}
</span><span class='line'>     }]
</span><span class='line'>   }
</span><span class='line'> },
</span><span class='line'>
</span><span class='line'>  "Type" : "AWS::IAM::AccessKey",
</span><span class='line'>  "Properties" : {
</span><span class='line'>    "UserName" : { "Ref": "CfnUser" } 
</span><span class='line'>  }
</span><span class='line'>  </span></code></pre></td></tr></table></div></figure>


<p> We create the AWS IAM user and then create the <a href="http://docs.amazonwebservices.com/AWSCloudFormation/latest/UserGuide/aws-properties-iam-accesskey.html">AWS Access and Secret access keys</a> for the IAM user which are used throughout the rest of the template. Access and Secret access keys are authentication keys used to authenticate to the AWS account.</p>

<p><strong><a href="http://docs.amazonwebservices.com/AWSCloudFormation/latest/UserGuide/aws-properties-sns-topic.html">AWS::SNS::Topic</a></strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> "MySNSTopic" : {
</span><span class='line'>   "Type" : "AWS::SNS::Topic",
</span><span class='line'>   "Properties" : {
</span><span class='line'>     "Subscription" : [ {
</span><span class='line'>       "Endpoint" : { "Ref": "Email" },
</span><span class='line'>       "Protocol" : "email"
</span><span class='line'>     } ]
</span><span class='line'>   } },</span></code></pre></td></tr></table></div></figure>


<p>SNS is a highly available solution for sending notifications. In the Manatee infrastructure it is used for sending notifications to the development team.</p>

<p><strong><a href="http://docs.amazonwebservices.com/AWSCloudFormation/latest/UserGuide/aws-properties-route53-recordsetgroup.html">AWS::Route53::RecordSetGroup</a></strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> "JenkinsDNS" : {
</span><span class='line'>   "Type" : "AWS::Route53::RecordSetGroup",
</span><span class='line'>   "Properties" : {
</span><span class='line'>     "HostedZoneName" : { "Fn::Join" : [ "", [ {"Ref" : "HostedZone"}, "." ]]},
</span><span class='line'>     "RecordSets" : [{       "Name" : { "Fn::Join" : ["", [ { "Ref" : "ApplicationName" }, ".", { "Ref" : "HostedZone" }, "." ]]},
</span><span class='line'>       "Type" : "A",
</span><span class='line'>       "TTL" : "900",
</span><span class='line'>       "ResourceRecords" : [ { "Ref" : "IPAddress" } ]
</span><span class='line'>     }]
</span><span class='line'>   }
</span><span class='line'> },</span></code></pre></td></tr></table></div></figure>


<p>Route53 is a highly available DNS service. We use Route53 to create domains dynamically using the given HostedZone and ApplicationName parameters. If the parameters are not overriden, the domain jenkins.integratebutton.com will be created. We then reference the Elastic IP and associate it with the created domain. This way the jenkins.integratebutton.com domain will route to the created instance</p>

<p><strong><a href="http://docs.amazonwebservices.com/AWSCloudFormation/latest/UserGuide/aws-properties-ec2-instance.html">AWS::EC2::Instance</a></strong></p>

<p>EC2 gives access to on-demand compute resources. In this template, we allocate a new EC2 instance and configure it with a Keypair, Security Group, and Image ID (AMI). Then for provisioning the EC2 instance we use the <code>UserData</code> property. Inside <code>UserData</code> we run a set of bash commands along with <code>cfn_init</code>. The <code>UserData</code> script is run during instance creation.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> "WebServer": {
</span><span class='line'>   "Type": "AWS::EC2::Instance",
</span><span class='line'>   "Metadata" : {
</span><span class='line'>     "AWS::CloudFormation::Init" : {
</span><span class='line'>       "config" : {
</span><span class='line'>         "packages" : {
</span><span class='line'>           "yum" : {
</span><span class='line'>             "tomcat6" : [],
</span><span class='line'>             "subversion" : [],
</span><span class='line'>             "git" : [],
</span><span class='line'>             "gcc" : [],
</span><span class='line'>             "libxslt-devel" : [],
</span><span class='line'>             "ruby-devel" : [],
</span><span class='line'>             "httpd" : []
</span><span class='line'>           }
</span><span class='line'>         },
</span><span class='line'>
</span><span class='line'>        “sources” : {
</span><span class='line'>           “/opt/aws/apitools/cfn” : { “Fn::Join” : [“”,[“https://s3.amazonaws.com/”, { “Ref” : “S3Bucket” }, “/resources/aws_tools/cfn-cli.tar.gz”]]},
</span><span class='line'>           “/opt/aws/apitools/sns” : { “Fn::Join” : [“”, [“https://s3.amazonaws.com/”, { “Ref” : “S3Bucket” }, “/resources/aws_tools/sns-cli.tar.gz”]]}
</span><span class='line'>         },
</span><span class='line'>
</span><span class='line'>        “files” : {
</span><span class='line'>           “/usr/share/tomcat6/webapps/jenkins.war” : {
</span><span class='line'>             “source” : “http://mirrors.jenkins-ci.org/war/1.480/jenkins.war”,
</span><span class='line'>             “mode” : “000700”,
</span><span class='line'>             “owner” : “tomcat”,
</span><span class='line'>             “group” : “tomcat”,
</span><span class='line'>             “authentication” : “S3AccessCreds”
</span><span class='line'>           },
</span><span class='line'>
</span><span class='line'>          “/usr/share/tomcat6/webapps/nexus.war” : {
</span><span class='line'>             “source” : “http://www.sonatype.org/downloads/nexus-2.0.3.war”,
</span><span class='line'>             “mode” : “000700”,
</span><span class='line'>             “owner” : “tomcat”,
</span><span class='line'>             “group” : “tomcat”,
</span><span class='line'>             “authentication” : “S3AccessCreds”
</span><span class='line'>           },
</span><span class='line'>
</span><span class='line'>          “/usr/share/tomcat6/.ssh/id_rsa” : {
</span><span class='line'>             “source” : { “Fn::Join” : [“”, [“https://s3.amazonaws.com/”, { “Ref” : “S3Bucket” }, “/private/id_rsa”]]},
</span><span class='line'>             “mode” : “000600”,
</span><span class='line'>             “owner” : “tomcat”,
</span><span class='line'>             “group” : “tomcat”,
</span><span class='line'>             “authentication” : “S3AccessCreds”
</span><span class='line'>           },
</span><span class='line'>
</span><span class='line'>          “/home/ec2-user/common-step-definitions-1.0.0.gem” : {
</span><span class='line'>             “source” : { “Fn::Join” : [“”,[“https://s3.amazonaws.com/”, { “Ref” : “S3Bucket” }, “/gems/common-step-definitions-1.0.0.gem”]]},
</span><span class='line'>             “mode” : “000700”,
</span><span class='line'>             “owner” : “root”,
</span><span class='line'>             “group” : “root”,
</span><span class='line'>             “authentication” : “S3AccessCreds”
</span><span class='line'>           },
</span><span class='line'>
</span><span class='line'>          “/etc/cron.hourly/jenkins_backup.sh” : {
</span><span class='line'>             “source” : { “Fn::Join” : [“”, [“https://s3.amazonaws.com/”, { “Ref” : “S3Bucket” }, “/jenkins_backup.sh”]]},
</span><span class='line'>             “mode” : “000500”,
</span><span class='line'>             “owner” : “root”,
</span><span class='line'>             “group” : “root”,
</span><span class='line'>             “authentication” : “S3AccessCreds”
</span><span class='line'>           },
</span><span class='line'>
</span><span class='line'>          “/etc/tomcat6/server.xml” : {
</span><span class='line'>             “source” : { “Fn::Join” : [“”, [“https://s3.amazonaws.com/”, { “Ref” : “S3Bucket” }, “/server.xml”]]},
</span><span class='line'>             “mode” : “000554”,
</span><span class='line'>             “owner” : “root”,
</span><span class='line'>             “group” : “root”,
</span><span class='line'>             “authentication” : “S3AccessCreds”
</span><span class='line'>           },
</span><span class='line'>
</span><span class='line'>          “/usr/share/tomcat6/aws_access” : {
</span><span class='line'>             “content” : { “Fn::Join” : [“”, [
</span><span class='line'>               “AWSAccessKeyId=”, { “Ref” : “HostKeys” }, “n”,
</span><span class='line'>               “AWSSecretKey=”, {“Fn::GetAtt”: [“HostKeys”, “SecretAccessKey”]}
</span><span class='line'>             ]]},
</span><span class='line'>             “mode” : “000400”,
</span><span class='line'>             “owner” : “tomcat”,
</span><span class='line'>             “group” : “tomcat”,
</span><span class='line'>             “authentication” : “S3AccessCreds”
</span><span class='line'>           },
</span><span class='line'>
</span><span class='line'>          “/opt/aws/aws.config” : {
</span><span class='line'>             “content” : { “Fn::Join” : [“”, [
</span><span class='line'>               “AWS.config(n”,
</span><span class='line'>               “:access_key_id =&gt; ”“, {”Ref" : “HostKeys” }, “”,n",
</span><span class='line'>               “:secret_access_key =&gt; ”“, {”Fn::GetAtt“: [”HostKeys“,”SecretAccessKey“]},”“)n”
</span><span class='line'>             ]]},
</span><span class='line'>             “mode” : “000500”,
</span><span class='line'>             “owner” : “tomcat”,
</span><span class='line'>             “group” : “tomcat”
</span><span class='line'>           },
</span><span class='line'>
</span><span class='line'>          “/etc/httpd/conf/httpd.conf2” : {
</span><span class='line'>             “content” : { “Fn::Join” : [“”, [
</span><span class='line'>               “NameVirtualHost *:80n”,
</span><span class='line'>               “n”,
</span><span class='line'>               “ProxyPass /jenkins http://”, { “Fn::Join” : [“”, [{ “Ref” : “ApplicationName” }, “.”, { “Ref” : “HostedZone” }]] }, “:8080/jenkinsn”,
</span><span class='line'>               “ProxyPassReverse /jenkins http://”, { “Fn::Join” : [“”,[{ “Ref” : “ApplicationName” }, “.”, { “Ref” : “HostedZone” }]] },“:8080/jenkinsn”,
</span><span class='line'>               “ProxyRequests Offn”,
</span><span class='line'>              “n”,
</span><span class='line'>               “Order deny,allown”,
</span><span class='line'>               “Allow from alln”,
</span><span class='line'>               “n”,
</span><span class='line'>               “RewriteEngine Onn”,
</span><span class='line'>               “RewriteRule ^/$ http://”, { “Fn::Join” : [“”, [{ “Ref” : “ApplicationName” }, “.”, { “Ref” : “HostedZone” }]] },“:8080/jenkins$1 [NC,P]n”, “”
</span><span class='line'>             ]]},
</span><span class='line'>             “mode” : “000544”,
</span><span class='line'>             “owner” : “root”,
</span><span class='line'>             “group” : “root”
</span><span class='line'>           },
</span><span class='line'>
</span><span class='line'>          “/root/.ssh/config” : {
</span><span class='line'>             “content” : { “Fn::Join” : [“”, [
</span><span class='line'>               “Host github.comn”,
</span><span class='line'>               “StrictHostKeyChecking non”
</span><span class='line'>             ]]},
</span><span class='line'>             “mode” : “000600”,
</span><span class='line'>             “owner” : “root”,
</span><span class='line'>             “group” : “root”
</span><span class='line'>           },
</span><span class='line'>
</span><span class='line'>          “/usr/share/tomcat6/.route53” : {
</span><span class='line'>             “content” : { “Fn::Join” : [“”, [
</span><span class='line'>               “access_key:”, { “Ref” : “HostKeys” }, “n”,
</span><span class='line'>               “secret_key:”, {“Fn::GetAtt”: [“HostKeys”,“SecretAccessKey”]}, “n”,
</span><span class='line'>               “api: ‘2012-02-29’n”,
</span><span class='line'>               “endpoint: https://route53.amazonaws.com/n”,
</span><span class='line'>               “default_ttl: ‘3600’”
</span><span class='line'>             ]]},
</span><span class='line'>             “mode” : “000700”,
</span><span class='line'>             “owner” : “tomcat”,
</span><span class='line'>             “group” : “tomcat”
</span><span class='line'>           }
</span><span class='line'>         }
</span><span class='line'>       }
</span><span class='line'>     },
</span><span class='line'>
</span><span class='line'>     “AWS::CloudFormation::Authentication” : {
</span><span class='line'>       “S3AccessCreds” : {
</span><span class='line'>         “type” : “S3”,
</span><span class='line'>         “accessKeyId” : { “Ref” : “HostKeys” },
</span><span class='line'>         “secretKey” : {“Fn::GetAtt”: [“HostKeys”, “SecretAccessKey”]},
</span><span class='line'>         “buckets” : [ { “Ref” : “S3Bucket”} ]
</span><span class='line'>       }
</span><span class='line'>     }
</span><span class='line'>   },
</span><span class='line'>
</span><span class='line'>   “Properties”: {
</span><span class='line'>     “ImageId” : { “Fn::FindInMap” : [ “AWSRegionArch2AMI”, { “Ref” : “AWS::Region” }, { “Fn::FindInMap” : [ “AWSInstanceType2Arch”, { “Ref” : “InstanceType” }, “Arch” ] } ] },
</span><span class='line'>     “InstanceType” : { “Ref” : “InstanceType” },
</span><span class='line'>     “SecurityGroups” : [ {“Ref” : “FrontendGroup”} ],
</span><span class='line'>     “KeyName” : { “Ref” : “KeyName” },
</span><span class='line'>     “Tags”: [ { “Key”: “Name”, “Value”: “Jenkins” } ],
</span><span class='line'>     “UserData” : { “Fn::Base64” : { “Fn::Join” : [“”, [
</span><span class='line'>       “#!/bin/bash -vn”,
</span><span class='line'>       “yum -y install java-1.6.0-openjdk*n”,
</span><span class='line'>       “yum update -y aws-cfn-bootstrapn”,
</span><span class='line'>
</span><span class='line'>      “# Install packagesn”,
</span><span class='line'>       “/opt/aws/bin/cfn-init -s”, { “Ref” : “AWS::StackName” }, " -r WebServer ",
</span><span class='line'>       " –access-key “, {”Ref" : “HostKeys” },
</span><span class='line'>       " –secret-key “, {”Fn::GetAtt“: [”HostKeys“,”SecretAccessKey"]},
</span><span class='line'>       " –region “, {”Ref" : “AWS::Region” }, " || error_exit ‘Failed to run cfn-init’n",
</span><span class='line'>
</span><span class='line'>      “# Copy Github credentials to root ssh directoryn”,
</span><span class='line'>       “cp /usr/share/tomcat6/.ssh/* /root/.ssh/n”,
</span><span class='line'>
</span><span class='line'>      “# Installing Ruby 1.9.3 from RPMn”,
</span><span class='line'>       “wget -P /home/ec2-user/ https://s3.amazonaws.com/”, { “Ref” : “S3Bucket” }, “/resources/rpm/ruby-1.9.3p0-2.amzn1.x86_64.rpmn”,
</span><span class='line'>       “rpm -Uvh /home/ec2-user/ruby-1.9.3p0-2.amzn1.x86_64.rpmn”,
</span><span class='line'>
</span><span class='line'>      “cat /etc/httpd/conf/httpd.conf2 &gt;&gt; /etc/httpd/conf/httpd.confn”,
</span><span class='line'>
</span><span class='line'>      “# Install S3 Gemsn”,
</span><span class='line'>       “gem install /home/ec2-user/common-step-definitions-1.0.0.gemn”,
</span><span class='line'>
</span><span class='line'>      “# Install Public Gemsn”,
</span><span class='line'>       “gem install bundler –version 1.1.4 –no-rdoc –no-rin”,
</span><span class='line'>       “gem install aws-sdk –version 1.5.6 –no-rdoc –no-rin”,
</span><span class='line'>       “gem install cucumber –version 1.2.1 –no-rdoc –no-rin”,
</span><span class='line'>       “gem install net-ssh –version 2.5.2 –no-rdoc –no-rin”,
</span><span class='line'>       “gem install capistrano –version 2.12.0 –no-rdoc –no-rin”,
</span><span class='line'>       “gem install route53 –version 0.2.1 –no-rdoc –no-rin”,
</span><span class='line'>       “gem install rspec –version 2.10.0 –no-rdoc –no-rin”,
</span><span class='line'>       “gem install trollop –version 2.0 –no-rdoc –no-rin”,
</span><span class='line'>
</span><span class='line'>      “# Update Jenkins with versioned configurationn”,
</span><span class='line'>       “rm -rf /usr/share/tomcat6/.jenkinsn”,
</span><span class='line'>       “git clone git@github.com:stelligent/continuous_delivery_open_platform_jenkins_configuration.git /usr/share/tomcat6/.jenkinsn”,
</span><span class='line'>
</span><span class='line'>      “# Get S3 bucket publisher from S3n”,
</span><span class='line'>       “wget -P /usr/share/tomcat6/.jenkins/ https://s3.amazonaws.com/”, { “Ref” : “S3Bucket” }, “/hudson.plugins.s3.S3BucketPublisher.xmln”,
</span><span class='line'>
</span><span class='line'>      “wget -P /tmp/ https://raw.github.com/stelligent/continuous_delivery_open_platform/master/config/aws/cd_security_group.rbn”,
</span><span class='line'>       “ruby /tmp/cd_security_group –securityGroupName”, { “Ref” : “FrontendGroup” }, " –port 5432n",
</span><span class='line'>
</span><span class='line'>      “# Update main Jenkins confign”,
</span><span class='line'>       “sed -i ’s@.*@”, { “Ref” : “HostKeys” }, “@’ /usr/share/tomcat6/.jenkins/hudson.plugins.s3.S3BucketPublisher.xmln”,
</span><span class='line'>       “sed -i ‘s@.*@“, {”Fn::GetAtt“: [”HostKeys“,”SecretAccessKey“]},”@’ /usr/share/tomcat6/.jenkins/hudson.plugins.s3.S3BucketPublisher.xmln”,
</span><span class='line'>
</span><span class='line'>      “# Add AWS Credentials to Tomcatn”,
</span><span class='line'>       “echo ”AWS_ACCESS_KEY=“, {”Ref" : “HostKeys” }, “” &gt;&gt; /etc/sysconfig/tomcat6n",
</span><span class='line'>       “echo ”AWS_SECRET_ACCESS_KEY=“, {”Fn::GetAtt“: [”HostKeys“,”SecretAccessKey“]},”" &gt;&gt; /etc/sysconfig/tomcat6n",
</span><span class='line'>
</span><span class='line'>      “# Add AWS CLI Toolsn”,
</span><span class='line'>       “echo ”export AWS_CLOUDFORMATION_HOME=/opt/aws/apitools/cfn" &gt;&gt; /etc/sysconfig/tomcat6n",
</span><span class='line'>       “echo ”export AWS_SNS_HOME=/opt/aws/apitools/sns" &gt;&gt; /etc/sysconfig/tomcat6n",
</span><span class='line'>       “echo ”export PATH=$PATH:/opt/aws/apitools/sns/bin:/opt/aws/apitools/cfn/bin" &gt;&gt; /etc/sysconfig/tomcat6n",
</span><span class='line'>
</span><span class='line'>      “# Add Jenkins Environment Variablen”,
</span><span class='line'>       “echo ”export SNS_TOPIC=“, {”Ref" : “MySNSTopic” }, “” &gt;&gt; /etc/sysconfig/tomcat6n",
</span><span class='line'>       “echo ”export JENKINS_DOMAIN=“, {”Fn::Join" : [“”, [“http://”,{ “Ref” : “ApplicationName” }, “.”, { “Ref” : “HostedZone” }]] }, “”&gt;&gt; /etc/sysconfig/tomcat6n",
</span><span class='line'>       “echo ”export JENKINS_ENVIRONMENT=“, {”Ref" : “ApplicationName” }, “” &gt;&gt; /etc/sysconfig/tomcat6n",
</span><span class='line'>
</span><span class='line'>      “wget -P /tmp/ https://raw.github.com/stelligent/continuous_delivery_open_platform/master/config/aws/showback_domain.rbn”,
</span><span class='line'>       “echo ”export SGID=`ruby /tmp/showback_domain.rb –item properties –key SGID`" &gt;&gt; /etc/sysconfig/tomcat6n",
</span><span class='line'>
</span><span class='line'>      “chown -R tomcat:tomcat /usr/share/tomcat6/n”,
</span><span class='line'>       “chmod +x /usr/share/tomcat6/scripts/aws/*n”,
</span><span class='line'>       “chmod +x /opt/aws/apitools/cfn/bin/*n”,
</span><span class='line'>
</span><span class='line'>      “service tomcat6 restartn”,
</span><span class='line'>       “service httpd restartn”,
</span><span class='line'>
</span><span class='line'>      “/opt/aws/bin/cfn-signal”, " -e 0“,” ’“, {”Ref" : “WaitHandle” },“’”
</span><span class='line'>     ]]}}
</span><span class='line'>   }
</span><span class='line'> },</span></code></pre></td></tr></table></div></figure>


<p> Calling <a href="http://docs.amazonwebservices.com/AWSCloudFormation/latest/UserGuide/cfn-init.html">cfn init</a> from <code>UserData</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> "# Install packagesn", 
</span><span class='line'>  "/opt/aws/bin/cfn-init -s ", { "Ref" : "AWS::StackName" }, " -r WebServer ",
</span><span class='line'>  " --access-key ", { "Ref" : "HostKeys" },
</span><span class='line'>  " --secret-key ", {"Fn::GetAtt": ["HostKeys", "SecretAccessKey"]},
</span><span class='line'>  " --region ", { "Ref" : "AWS::Region" }, " || error_exit 'Failed to run cfn-init'n", 
</span><span class='line'>  },</span></code></pre></td></tr></table></div></figure>


<p><code>cfn_init</code> is used to retrieve and interpret the resource metadata, installing packages, creating files and starting services. In the Manatee template we use <code>cfn_init</code> for easy access to other AWS resources, such as S3.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> "/etc/tomcat6/server.xml" : {
</span><span class='line'>   "source" : { "Fn::Join" : ["", ["https://s3.amazonaws.com/", { "Ref" : "S3Bucket" }, "/server.xml"]]},
</span><span class='line'>   "mode" : "000554",
</span><span class='line'>   "owner" : "root",
</span><span class='line'>   "group" : "root",
</span><span class='line'>   "authentication" : "S3AccessCreds" },
</span><span class='line'>
</span><span class='line'>   "AWS::CloudFormation::Authentication" : {
</span><span class='line'>     "S3AccessCreds" : {
</span><span class='line'>       "type" : "S3",
</span><span class='line'>       "accessKeyId" : { "Ref" : "HostKeys" },
</span><span class='line'>       "secretKey" : {"Fn::GetAtt": ["HostKeys", "SecretAccessKey"]},
</span><span class='line'>       "buckets" : [ { "Ref" : "S3Bucket"} ]
</span><span class='line'>     }
</span><span class='line'>   }</span></code></pre></td></tr></table></div></figure>


<p>When possible, we try to use <code>cfn_init</code> rather than <code>UserData</code> bash commands because it stores a detailed log of Cfn events on the instance.</p>

<p><strong><a href="http://docs.amazonwebservices.com/AWSCloudFormation/latest/UserGuide/aws-properties-ec2-security-group.html">AWS::EC2::SecurityGroup</a></strong></p>

<p>When creating a <a href="http://jenkins-ci.org/">Jenkins</a> instance, we only want certain ports to be open and only open to certain users. For this we use Security Groups. Security groups are firewall rules defined at the AWS level. You can use them to set which ports, or range of ports to be opened. In addition to defining which ports are to be open, you can define who they should be open to using CIDR.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> "FrontendGroup" : {
</span><span class='line'>   "Type" : "AWS::EC2::SecurityGroup",   
</span><span class='line'>   "Properties" : {
</span><span class='line'>     "GroupDescription" : "Enable SSH and access to Apache and Tomcat",
</span><span class='line'>     "SecurityGroupIngress" : [
</span><span class='line'>       {"IpProtocol" : "tcp", "FromPort" : "22", "ToPort" : "22", "CidrIp" : "0.0.0.0/0"},
</span><span class='line'>       {"IpProtocol" : "tcp", "FromPort" : "8080", "ToPort" : "8080", "CidrIp" : "0.0.0.0/0"},
</span><span class='line'>       {"IpProtocol" : "tcp", "FromPort" : "80", "ToPort" : "80", "CidrIp" : "0.0.0.0/0"}
</span><span class='line'>     ]
</span><span class='line'>   }
</span><span class='line'> },</span></code></pre></td></tr></table></div></figure>


<p>In this security group we are opening ports 22, 80 and 8080. Since we are opening 8080, we are able to access Jenkins at the completion of the template. By default, ports on an instance are closed, meaning these are necessary to be specified in order to have access to Jenkins.</p>

<p><strong><a href="http://docs.amazonwebservices.com/AWSCloudFormation/latest/UserGuide/aws-properties-ec2-eip.html">AWS::EC2::EIP</a></strong></p>

<p>When an instance is created, it is given a public DNS name similar to: ec2-107-20-139-148.compute-1.amazonaws.com. By using Elastic IPs, you can associate your instance an IP rather than a DNS.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> "IPAddress" : {   "Type" : "AWS::EC2::EIP" 
</span><span class='line'> },
</span><span class='line'>
</span><span class='line'>“IPAssoc” : {
</span><span class='line'>   “Type” : “AWS::EC2::EIPAssociation”,
</span><span class='line'>   “Properties” : {
</span><span class='line'>     “InstanceId” : { “Ref” : “WebServer” },
</span><span class='line'>     “EIP” : { “Ref” : “IPAddress” }
</span><span class='line'>   }
</span><span class='line'> },</span></code></pre></td></tr></table></div></figure>


<p> In the snippets above, we create a new Elastic IP and then associate it with the EC2 instance created above. We do this so we can reference the Elastic IP when creating the <a href="http://aws.amazon.com/route53/">Route53</a> Domain name.</p>

<p><strong><a href="http://docs.amazonwebservices.com/AWSCloudFormation/latest/UserGuide/aws-properties-cw-alarm.html">AWS::CloudWatch::Alarm</a></strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> "CPUAlarmLow": {
</span><span class='line'>   "Type": "AWS::CloudWatch::Alarm",
</span><span class='line'>   "Properties": {
</span><span class='line'>     "AlarmDescription": "Scale-down if CPU &lt; 70% for 10 minutes",
</span><span class='line'>     "MetricName": "CPUUtilization",     "Namespace": "AWS/EC2",
</span><span class='line'>     "Statistic": "Average",     "Period": "300",
</span><span class='line'>     "EvaluationPeriods": "2",
</span><span class='line'>     "Threshold": "70",
</span><span class='line'>     "AlarmActions": [ { "Ref": "SNSTopic" } ],
</span><span class='line'>     "Dimensions": [{
</span><span class='line'>       "Name": "WebServerName",
</span><span class='line'>       "Value": { "Ref": "WebServer" }
</span><span class='line'>     }],
</span><span class='line'>     "ComparisonOperator": "LessThanThreshold"
</span><span class='line'>   }
</span><span class='line'> },</span></code></pre></td></tr></table></div></figure>


<p>There are many reasons an instance can become unavailable. <a href="http://aws.amazon.com/cloudwatch/">CloudWatch</a> is used to monitor instance usage and performance. CloudWatch can be set to notify specified individuals if the instance experiences higher than normal CPU utilization, disk usage, network usage, etc. In the Manatee infrastructure we use CloudWatch to monitor disk utilization and notify team members if it reaches 90 percent.</p>

<p>If the Jenkins instance goes down, our CD pipeline becomes temporarily unavailable. This presents a problem as the development team is temporarily blocked from testing their code. CloudWatch helps notify us if this is an impending problem..</p>

<p><strong><a href="http://docs.amazonwebservices.com/AWSCloudFormation/latest/UserGuide/aws-properties-waitconditionhandle.html">AWS::CloudFormation::WaitConditionHandle</a>,
<a href="http://docs.amazonwebservices.com/AWSCloudFormation/latest/UserGuide/aws-properties-waitcondition.html">AWS::CloudFormation::WaitCondition</a></strong></p>

<p>Wait Conditions are used to wait for all of the resources in a template to be completed before signally template success.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> "WaitHandle" : {
</span><span class='line'>   "Type" : "AWS::CloudFormation::WaitConditionHandle" 
</span><span class='line'> },
</span><span class='line'>
</span><span class='line'>“WaitCondition” : {
</span><span class='line'>   “Type” : “AWS::CloudFormation::WaitCondition”,
</span><span class='line'>   “DependsOn” : “WebServer”,
</span><span class='line'>   “Properties” : {
</span><span class='line'>     “Handle” : { “Ref” : “WaitHandle” },
</span><span class='line'>     “Timeout” : “990”
</span><span class='line'>   }
</span><span class='line'> }</span></code></pre></td></tr></table></div></figure>


<p>When creating the instance, if a wait condition is not used, CloudFormation won’t wait for the completion of the <code>UserData</code> script. It will signal success if the EC2 instance is allocated successfully rather than waiting for the <code>UserData</code> script to run and signal success.</p>

<h2>Outputs</h2>

<p>Outputs are used to return information from what was created during the CloudFormaiton stack creation to the user. In order to return values, you define the Output name and then the resource you want to reference:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> "Outputs" : {
</span><span class='line'>   "Domain" : {
</span><span class='line'>     "Value" : { "Fn::Join" : ["", ["http://", { "Ref" : "ApplicationName" }, ".", { "Ref" : "HostedZone" }]]
</span><span class='line'> },
</span><span class='line'>     "Description" : "URL for newly created Jenkins app"   
</span><span class='line'> },
</span><span class='line'>   "NexusURL" : {
</span><span class='line'>     "Value" : { "Fn::Join" : ["", ["http://", { "Ref" : "IPAddress" }, ":8080/nexus"]] },
</span><span class='line'>     "Description" : "URL for newly created Nexus repository"
</span><span class='line'>   },
</span><span class='line'>   "InstanceIPAddress" : {
</span><span class='line'>     "Value" : { "Ref" : "IPAddress"  }
</span><span class='line'>  } 
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>For instance with the InstanceIPAddress, we are refernceing the IPAddress resource which happens to be the Elastic IP. This will return the Elastic IP address to the CloudFormation console.</p>

<p>CloudFormation allows us to completely script and version our infrastructure. This enables our infrastructure to be recreated the same way every time by just running the CloudFormation template. Because of this, your environments can be run in a Continuous integration cycle, rebuilding with every change in the script.</p>

<p>In the next part of our series – which is all about Dynamic Configuration – we’ll go through building your infrastructure to only require a minimal amount of hard coded properties if any. In this next article, you’ll see how you can use CloudFormation to build “property file less” infrastructure.</p>

<p>Resources:</p>

<ul>
<li><a href="http://aws.amazon.com/cloudformation/">http://aws.amazon.com/cloudformation/</a></li>
<li><a href="http://docs.amazonwebservices.com/AWSCloudFormation/latest/UserGuide/aws-template-resource-type-ref.html">http://docs.amazonwebservices.com/AWSCloudFormation/latest/UserGuide/aws-template-resource-type-ref.html</a></li>
</ul>


  
    <footer>
      
      
        <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://bvajjala.github.io/projects/tutorials/cdincloud/cd-in-the-cloud-part-3-of-6.html" data-via="BVajjala" data-counturl="http://bvajjala.github.io/projects/tutorials/cdincloud/cd-in-the-cloud-part-3-of-6.html" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

      
    </footer>
  
</article>


</div>

<aside class="sidebar">
  
    <section>
  <h1>About Me</h1>
  <p>A little something about me.</p>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/02/22/jenkins-job-builder-and-how-to-extned-it/">Jenkins Job Builder and How to Extned it</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/02/04/nodejs-deployment-building-and-configuring-on-amazon-linux-ami/">Nodejs Deployment: Building and Configuring on Amazon Linux AMI</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/02/04/deploy-slash-release-workflow-from-github/">Deploy/Release Workflow from GitHub</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/02/03/designing-a-restful-api-that-doesnt-suck/">Designing A RESTful API That Doesn't Suck</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/02/03/i-can-haz-init-script/">I Can Haz Init Script</a>
      </li>
    
  </ul>
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/bvajjala@gmail.com?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Balaji Vajjala -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a> | Themed with <a href="https://github.com/lucaslew/whitespace">Whitespace</a></span>
</p>

</footer>
  






<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
